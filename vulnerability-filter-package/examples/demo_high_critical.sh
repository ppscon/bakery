#!/bin/bash
# Quick demo of high/critical filtering

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
INPUT_FILE="$SCRIPT_DIR/input/aqua-scan.json"
OUTPUT_DIR="$SCRIPT_DIR/output"

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${GREEN}High/Critical Vulnerability Filtering Demo${NC}"
echo "=========================================="
echo

# Check if input file exists
if [ ! -f "$INPUT_FILE" ]; then
    echo -e "${RED}Error: Sample scan file not found at $INPUT_FILE${NC}"
    exit 1
fi

# Create output directory
mkdir -p "$OUTPUT_DIR"

# Run the high/critical filter
echo -e "${YELLOW}Filtering for high and critical vulnerabilities only...${NC}"
python3 "$SCRIPT_DIR/../scripts/filter_high_critical.py" \
    "$INPUT_FILE" \
    "$OUTPUT_DIR/high-critical-only.json"

# Display results
echo
echo -e "${GREEN}Results:${NC}"
echo -e "Original file: $INPUT_FILE"
echo -e "Filtered file: $OUTPUT_DIR/high-critical-only.json"
echo -e "CSV report:    $OUTPUT_DIR/high-critical-only.csv"
echo

# Show summary
if [ -f "$OUTPUT_DIR/high-critical-only.json" ]; then
    TOTAL=$(jq -r '.summary.total_vulnerabilities_scanned' "$OUTPUT_DIR/high-critical-only.json")
    CRITICAL=$(jq -r '.summary.critical_count' "$OUTPUT_DIR/high-critical-only.json")
    HIGH=$(jq -r '.summary.high_count' "$OUTPUT_DIR/high-critical-only.json")
    REDUCTION=$(jq -r '.summary.reduction_percentage' "$OUTPUT_DIR/high-critical-only.json")
    RISK_LEVEL=$(jq -r '.summary.risk_score.level' "$OUTPUT_DIR/high-critical-only.json")
    
    echo -e "${GREEN}Summary:${NC}"
    echo -e "  Total vulnerabilities scanned: ${YELLOW}$TOTAL${NC}"
    echo -e "  Critical vulnerabilities:      ${RED}$CRITICAL${NC}"
    echo -e "  High vulnerabilities:          ${YELLOW}$HIGH${NC}"
    echo -e "  Data reduction:                ${GREEN}$REDUCTION%${NC}"
    echo -e "  Risk level:                    ${RED}$RISK_LEVEL${NC}"
    echo
    
    echo -e "${GREEN}Top 5 Critical/High Vulnerabilities:${NC}"
    jq -r '.vulnerabilities[:5] | .[] | "  [\(.severity)] \(.cve_id) - CVSS \(.cvss_score) - \(.resource.name)"' \
        "$OUTPUT_DIR/high-critical-only.json"
    
    echo
    echo -e "${GREEN}Recommendations:${NC}"
    jq -r '.summary.recommendations[] | "  â€¢ " + .' "$OUTPUT_DIR/high-critical-only.json"
fi

echo
echo -e "${GREEN}Files created:${NC}"
ls -la "$OUTPUT_DIR"/high-critical-only.*
echo
echo -e "${GREEN}Demo complete!${NC}"