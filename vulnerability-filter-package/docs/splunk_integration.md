# Splunk Integration Guide

## Overview

This guide explains how to use the Aqua Vulnerability Filter solution to optimize the ingestion of Aqua Security scan results into Splunk, overcoming common challenges like payload size limits, complex nested structures, and excessive data volume.

## The Problem

Sending full Aqua scan results to Splunk typically encounters these issues:

1. **Payload Size**: JSON payloads exceed Splunk's HTTP Event Collector (HEC) maximum size (default ~1MB)
2. **Complex Structure**: Too many nested fields or arrays (e.g., CVEs per layer, secrets per file)
3. **Indexing Performance**: Large payloads cause indexing delays or dropped events
4. **License Consumption**: Data volume quickly exhausts Splunk license limits (e.g., a 10GB/day license depleted by one image scan)

## The Solution

Our solution streamlines scan data for Splunk by:

1. **Filtering by Severity**: Only include critical or high-severity vulnerabilities (CVSS ≥ 7.0)
2. **Delta Reporting**: Only include newly discovered issues
3. **Policy Violation Focus**: Option to include only vulnerabilities that violate policies
4. **Optimized Format**: Convert to Splunk-friendly event format
5. **Field Reduction**: Keep only essential fields to reduce payload size

## Workflow Diagram

```
                     +-------------------+
                     |                   |
                     |  Aqua Security    |
                     |  Scan Results     |
                     |  (aqua-scan.json) |
                     |                   |
                     +---------+---------+
                               |
                               v
                     +---------+---------+
                     |                   |   Extract only:
                     |  filter_for_      |   - High severity (CVSS ≥ 7.0)
                     |  splunk.py        |   - New vulnerabilities
                     |                   |   - Policy violations
                     +---------+---------+
                               |
                               | Creates three files:
                               v
+----------------+  +---------+---------+  +-------------------+
|                |  |                   |  |                   |
| filtered-for-  |  | filtered-for-     |  | filtered-for-     |
| splunk.json    |  | splunk_splunk.json|  | splunk_summary.json
| (Full report)  |  | (Splunk events)   |  | (Statistics)      |
|                |  |                   |  |                   |
+----------------+  +---------+---------+  +-------------------+
                               |
                               v
                     +---------+---------+
                     |                   |
                     |  send_to_         |   Batches events to
                     |  splunk.py        |   avoid HEC limits
                     |                   |
                     +---------+---------+
                               |
                               v
                     +---------+---------+
                     |                   |
                     |  Splunk HTTP      |
                     |  Event Collector  |
                     |                   |
                     +---------+---------+
                               |
                               v
                     +---------+---------+
                     |                   |
                     |  Splunk Indexers  |
                     |  and Search Heads |
                     |                   |
                     +-------------------+
```

## Usage Instructions

### Step 1: Filter Scan Data for Splunk

Filter the Aqua scan results to extract only relevant data:

```bash
python scripts/filter_for_splunk.py \
    input/aqua-scan.json \
    output/filtered-for-splunk.json \
    --min-severity 7.0 \
    --delta-only \
    --previous-scan previous/aqua-scan.json
```

Options:
- `--min-severity` - Minimum CVSS score to include (default: 7.0)
- `--delta-only` - Only include vulnerabilities not present in previous scan
- `--policy-violations-only` - Only include vulnerabilities that violate policies
- `--previous-scan` - Path to previous scan for delta comparison

### Step 2: Send Filtered Data to Splunk

Send the filtered data to Splunk using the HEC:

```bash
python scripts/send_to_splunk.py \
    output/filtered-for-splunk_splunk.json \
    --hec-url https://splunk.example.com:8088/services/collector \
    --token YOUR-SPLUNK-HEC-TOKEN \
    --batch-size 50
```

Options:
- `--hec-url` - Splunk HTTP Event Collector URL
- `--token` - Splunk HEC token
- `--batch-size` - Number of events to send in each batch (default: 100)
- `--no-verify-ssl` - Skip SSL certificate verification

## Splunk Dashboard Examples

For optimal visualization in Splunk, you can create dashboards that leverage the structured vulnerability data. Here's a sample SPL query:

```
index=security sourcetype="aqua:security:vulnerability" 
| stats count by vulnerability_id, severity, resource_name, resource_version
| sort -severity
```

## Integration with CI/CD

This solution can be integrated into CI/CD pipelines. Add these commands to your pipeline after an Aqua scan completes:

```yaml
# Example GitHub Actions step
- name: Filter Aqua results for Splunk
  run: |
    python filter_for_splunk.py aqua-scan.json filtered-for-splunk.json --min-severity 7.0
    
- name: Send to Splunk
  run: |
    python send_to_splunk.py filtered-for-splunk_splunk.json --hec-url ${{ secrets.SPLUNK_HEC_URL }} --token ${{ secrets.SPLUNK_HEC_TOKEN }}
```

## Troubleshooting

If you encounter issues:

1. Check the `filtered-for-splunk_summary.json` file for filtering statistics
2. Examine `filtered-for-splunk_splunk_report.json` for Splunk transmission results
3. Verify your Splunk HEC is properly configured to accept data
4. Ensure network connectivity between your system and Splunk

## Advanced Configuration

For more advanced configurations, refer to the scripts' help text:

```bash
python scripts/filter_for_splunk.py --help
python scripts/send_to_splunk.py --help
``` 