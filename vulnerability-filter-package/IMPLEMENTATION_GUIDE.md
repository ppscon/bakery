# Implementation Guide: Aqua-Splunk Integration

This guide explains how to implement the Aqua-Splunk vulnerability filtering solution in production environments.

## CI/CD Pipeline Integration

The most effective implementation is to integrate directly into your CI/CD pipeline that already uses Aqua Security scans.

### Pipeline Structure

```yaml
stages:
  - build
  - test
  - aqua_scan
  - process_vulnerabilities  # Our filter stage
  - splunk_integration       # Our reporting stage
  - deploy
```

### Dependencies

- The `process_vulnerabilities` stage has a direct dependency on the `aqua_scan` stage
- The scan output JSON file is passed between stages as an artifact

### Implementation Details

#### Aqua Scan Stage
```yaml
aqua_scan:
  script:
    - aqua scan -r ${REGISTRY}/${IMAGE}:${TAG} -o json > aqua-scan.json
  artifacts:
    paths:
      - aqua-scan.json
```

#### Process Vulnerabilities Stage
```yaml
process_vulnerabilities:
  dependencies:
    - aqua_scan
  script:
    - python3 scripts/filter_for_splunk.py aqua-scan.json filtered.json --min-severity 7.0
    # Optional: For delta reporting, retrieve previous scan from persistent storage
    # - aws s3 cp s3://your-bucket/previous-scan.json ./previous-scan.json
    # - python3 scripts/filter_for_splunk.py aqua-scan.json filtered.json --min-severity 7.0 --delta-only --previous-scan previous-scan.json
    # Store current scan for future delta comparisons
    # - aws s3 cp aqua-scan.json s3://your-bucket/previous-scan.json
  artifacts:
    paths:
      - filtered.json
      - filtered_splunk.json
      - filtered_summary.json
```

#### Splunk Integration Stage
```yaml
splunk_integration:
  dependencies:
    - process_vulnerabilities
  script:
    - python3 scripts/send_to_splunk.py filtered_splunk.json --hec-url ${SPLUNK_HEC_URL} --token ${SPLUNK_TOKEN}
```

### Configuration Options

The pipeline can be configured with:

- Environment variables for Splunk HEC URL and token
- Optional severity threshold customization
- Delta reporting enabled/disabled toggle
- Previous scan storage location (S3, Git LFS, artifact registry)

### Optional Deployment Gating

You can add conditional pipeline gates:

```yaml
deploy:
  dependencies:
    - process_vulnerabilities
  script:
    # Only deploy if no critical vulnerabilities found
    - if grep -q '"critical_vulnerabilities_count": 0' filtered_summary.json; then
        echo "No critical vulnerabilities, proceeding with deployment";
      else
        echo "Critical vulnerabilities found, halting deployment" && exit 1;
      fi
    - deploy_command
```

## Alternative Implementation: Scheduled Job

For organizations that prefer not to integrate directly with CI/CD:

1. Set up a scheduled job that runs hourly/daily
2. The job fetches the latest Aqua scan results via API
3. Processes them with our filter scripts
4. Sends the filtered data to Splunk
5. Stores the current scan for future delta comparisons

### Example Cron Job

```bash
#!/bin/bash
# This script runs as a scheduled job to process Aqua scans for Splunk

# Set variables
AQUA_API_URL="https://your-aqua-server/api/v2"
AQUA_USER="your-api-user"
AQUA_PASSWORD="your-api-password"
SPLUNK_HEC_URL="https://your-splunk.example.com:8088/services/collector"
SPLUNK_TOKEN="your-hec-token"
WORKSPACE="/opt/aqua-splunk-integration"
DATE=$(date +%Y-%m-%d)

# Navigate to workspace
cd $WORKSPACE

# Fetch authentication token
TOKEN=$(curl -s -X POST \
  -H "Content-Type: application/json" \
  -d '{"id":"'"$AQUA_USER"'","password":"'"$AQUA_PASSWORD"'"}' \
  $AQUA_API_URL/login | jq -r .token)

# Get latest scan results
curl -s -X GET \
  -H "Authorization: Bearer $TOKEN" \
  $AQUA_API_URL/containers?filter=scan_status=finished&pagesize=100 \
  | jq . > aqua-scan-$DATE.json

# Check if we have a previous scan
if [ -f "previous-scan.json" ]; then
  # Process with delta reporting
  python3 scripts/filter_for_splunk.py aqua-scan-$DATE.json filtered-$DATE.json \
    --min-severity 7.0 --delta-only --previous-scan previous-scan.json
else
  # Process without delta reporting
  python3 scripts/filter_for_splunk.py aqua-scan-$DATE.json filtered-$DATE.json \
    --min-severity 7.0
fi

# Send to Splunk
python3 scripts/send_to_splunk.py filtered-${DATE}_splunk.json \
  --hec-url $SPLUNK_HEC_URL --token $SPLUNK_TOKEN

# Save current scan as previous for next run
cp aqua-scan-$DATE.json previous-scan.json
```

## API-Triggered Implementation

For environments using Aqua's webhook capabilities:

1. Set up a lightweight web service that receives webhooks from Aqua
2. When a scan completes, Aqua sends a notification to your service
3. Your service downloads the scan results via Aqua API
4. Process the results with our filter scripts
5. Send the filtered data to Splunk

## Security Considerations

- Store API credentials and Splunk tokens securely
- Consider encrypting stored scan data
- Use network security controls to restrict access to Splunk HEC endpoints
- Use lowest-privilege accounts for API access
- Implement appropriate logging and monitoring for the integration process itself

## Command Reference

### Filter Command
```
python3 scripts/filter_for_splunk.py input.json output.json [OPTIONS]

Options:
  --min-severity FLOAT       Minimum CVSS score to include (default: 0.0)
  --delta-only               Only include vulnerabilities not in previous scan
  --previous-scan FILENAME   Path to previous scan for delta comparison
  --include-policy           Include policy violations in output
  --splunk-sourcetype TEXT   Sourcetype for Splunk events (default: aqua:vulnerability)
  --help                     Show help message
```

### Splunk Send Command
```
python3 scripts/send_to_splunk.py input_splunk.json [OPTIONS]

Options:
  --hec-url TEXT             Splunk HEC URL (required)
  --token TEXT               Splunk HEC token (required)
  --index TEXT               Splunk index (default: main)
  --batch-size INTEGER       Number of events per batch (default: 100)
  --retry-count INTEGER      Number of retries on failure (default: 3)
  --help                     Show help message
``` 