# Aqua Security Report Filtering Solution Guide

## Executive Summary

This document describes a custom solution developed for seamlessly filtering ignored vulnerabilities from Aqua Security scan reports. This implementation addresses a critical migration need, allowing the transition from PA Prisma to Aqua Security without disrupting existing workflows and reporting processes.

## Problem Statement

During migration from PA Prisma to Aqua Security, a key difference in handling ignored vulnerabilities was identified:

- **PA Prisma Behavior**: Completely removes ignored vulnerabilities from reports
- **Aqua Security Default Behavior**: Shows ignored vulnerabilities in reports but marks them as compliant

This difference would cause numerous previously-suppressed vulnerabilities to reappear in reports, potentially disrupting established security workflows and flooding existing downstream processes.

## Solution Overview

Rather than waiting for product-level changes, we implemented a post-processing step in the CI/CD pipeline that:

1. Captures the standard Aqua Security scan reports (JSON and HTML)
2. Automatically detects and filters out any vulnerabilities marked as ignored in Aqua
3. Generates enhanced, modernized reports from the filtered data
4. Properly assigns severity levels to vulnerabilities
5. Provides accurate summary metrics (counts of Critical, High, Medium, etc.)
6. Replaces shell variables in reports with actual values (like ${GITHUB_SHA})
7. Publishes reports to GitHub Pages for easy access and sharing

This provides a seamless experience, allowing teams to focus only on actionable security issues while maintaining the benefits of Aqua's security scanning.

## Implementation Details

### Python Scripts

We developed specialized Python scripts to handle the filtering and reporting:

#### 1. `filter_aqua_reports.py`

This script orchestrates the filtering process:

- **Purpose**: Coordinate the filtering of ignored vulnerabilities from JSON and HTML reports
- **Functionality**:
  - Processes command-line arguments and configuration
  - Determines which CVEs to ignore
  - Calls other scripts to perform specific filtering tasks
- **Usage**: `python filter_aqua_reports.py --input-dir artifacts --output-dir filtered-artifacts --ignored-cves CVE-2025-27789 CVE-2024-45590`

#### 2. `process_index_page.py`

This script processes HTML reports to fix severity values and replace variables:

- **Purpose**: Enhance HTML reports with accurate severity data and variable substitution
- **Functionality**:
  - Replaces shell-style variables (${GITHUB_SHA}, $(date))
  - Maps CVE scores to severity levels (Critical, High, Medium, etc.)
  - Updates severity badges in vulnerability tables
  - Recalculates severity metrics in summary cards
  - Updates severity chart with proper proportional widths
  - Changes the title from "Elegant Security Report" to "Curated Vulnerability Report"
  - Provides detailed logging and metrics about changes made
- **Usage**: `python process_index_page.py input.html output.html`

```python
# Key functionality excerpt
def process_html_report(input_file, output_file):
    # Load HTML content
    with open(input_file, 'r', encoding='utf-8') as f:
        html_content = f.read()
    
    # Replace shell variables
    github_sha = os.environ.get('GITHUB_SHA', 'latest')
    current_date = os.environ.get('BUILD_DATE', 
                               os.popen('date "+%Y-%m-%d %H:%M:%S"').read().strip())
    
    # Count replaced variables
    vars_replaced = 0
    html_content_new = re.sub(r'\${GITHUB_SHA}', github_sha, html_content)
    if html_content_new != html_content:
        vars_replaced += 1
        html_content = html_content_new
    
    # Parse with BeautifulSoup
    soup = BeautifulSoup(html_content, 'html.parser')
    
    # Fix severity values and update severity metrics
    rows_updated = 0
    severity_counts = {'Critical': 0, 'High': 0, 'Medium': 0, 'Low': 0, 'Negligible': 0}
    
    # Process each vulnerability row
    for row in soup.find_all('tr'):
        # Process each vulnerability's severity
        # ...
```

#### 3. `create_elegant_report.py`

This script transforms the filtered data into a modern, visually appealing report:

- **Purpose**: Generate a user-friendly, modern HTML dashboard from the filtered data
- **Functionality**:
  - Processes the filtered JSON data
  - Creates summary statistics for vulnerabilities by severity
  - Organizes vulnerabilities by resource/component
  - Produces a responsive HTML report with modern styling
- **Usage**: `python create_elegant_report.py filtered.json elegant_report.html`

### Integration with CI/CD Pipeline

The solution is fully integrated into the GitHub Actions workflow:

1. **Aqua Security Scan Job**:
   - Runs the standard Aqua security scan
   - Generates original JSON and HTML reports

2. **Filter Vulnerabilities Job**:
   - Downloads the original Aqua reports
   - Runs the filtering scripts to remove ignored vulnerabilities
   - Generates the elegant HTML report
   - Uploads filtered reports as artifacts

3. **GitHub Pages Publishing Job**:
   - Creates an index page for easy navigation
   - Processes the index page to replace variables and fix severity metrics
   - Publishes all reports to GitHub Pages
   - Makes reports accessible via URL: https://ppscon.github.io/bakery/security-reports/

```yaml
# Key workflow excerpt
filter_aqua_reports:
  runs-on: ubuntu-latest
  needs: aqua_scan
  steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Setup Python
      uses: actions/setup-python@v5
    - name: Install dependencies
      run: pip install beautifulsoup4
    - name: Filter ignored vulnerabilities
      run: python ci_scripts/filter_aqua_reports.py --input-dir artifacts --output-dir filtered-artifacts --ignored-cves CVE-2025-27789 CVE-2024-45590
    - name: Create elegant report
      run: python ci_scripts/create_elegant_report.py filtered-artifacts/aqua-scan-filtered.json filtered-artifacts/elegant-report.html
```

```yaml
# Key workflow excerpt - index page processing
publish_to_gh_pages:
  # ...
  steps:
    # ...
    - name: Create index page for reports
      run: |
        # Create the index.html file
        # ...
        
        # Install required dependencies
        pip install beautifulsoup4 
        
        # Process the index.html file to replace variables
        python3 ci_scripts/process_index_page.py ./security-reports/index.html ./security-reports/index.html
```

## Benefits

This solution provides several immediate benefits:

1. **Seamless Migration**: Maintains the same experience users had with PA Prisma
2. **Workflow Continuity**: Prevents ignored vulnerabilities from disrupting existing processes
3. **Enhanced Visualization**: Provides modern, intuitive security dashboards
4. **Improved Accessibility**: Makes reports available through GitHub Pages
5. **Accurate Severity Information**: Correctly maps CVE scores to severity levels
6. **Proper Variable Substitution**: Replaces shell variables with actual values
7. **Detailed Metrics**: Provides accurate vulnerability counts by severity
8. **Transparent Processing**: Logs details about changes made during processing

## Recent Improvements

Recent enhancements to the solution include:

1. **Fixed Filtering Logic**: Corrected a bug where ignored CVEs were shown instead of being removed
2. **Severity Value Calculation**: Implemented proper mapping of CVE scores to severity levels
3. **Variable Substitution**: Added detection and replacement of shell variables like ${GITHUB_SHA}
4. **Accurate Metrics**: Fixed severity metrics to show actual counts instead of zeroes
5. **Visual Improvements**: Updated the severity chart with proportional widths
6. **Title Update**: Changed the report title from "Elegant Security Report" to "Curated Vulnerability Report"
7. **Enhanced Logging**: Added detailed logging and metrics about all changes made during processing
8. **Automated Testing**: Implemented test_filtering.py to validate the filtering and processing logic

## Accessing Reports

Filtered security reports are available at:
- https://ppscon.github.io/bakery/security-reports/

The page provides access to:
- **Elegant Report**: Modern dashboard view of vulnerabilities
- **HTML Report**: Standard format but with ignored vulnerabilities removed
- **JSON Data**: Filtered data for integration with other tools

## Configuration Options

The solution offers multiple ways to control which vulnerabilities are filtered:

### 1. Automatic Detection (Default)

By default, the system automatically detects vulnerabilities that have been marked as ignored in the Aqua UI.

### 2. Environment Variables

You can provide specific CVEs to filter via environment variables:

```bash
export AQUA_IGNORED_CVES="CVE-2025-27789,CVE-2023-12345,CVE-2024-56789"
```

### 3. Configuration File

For more permanent configurations, you can use a JSON configuration file:

```json
{
  "ignored_cves": [
    "CVE-2025-27789",
    "CVE-2023-12345"
  ]
}
```

And use it with:

```bash
python ci_scripts/filter_aqua_reports.py --config-file ignored_cves_config.json
```

### 4. Command-Line Arguments

For one-off filtering, you can specify CVEs directly:

```bash
python ci_scripts/filter_aqua_reports.py --ignored-cves CVE-2025-27789 CVE-2023-12345
```

## Conclusion

This implementation provides an immediate solution to ensure a smooth transition from PA Prisma to Aqua Security. It maintains workflow continuity while providing enhanced visualization and reporting capabilities, all without requiring changes to the core Aqua product.

The intelligent design automatically adapts to your ignored vulnerability settings without manual maintenance, and can be retired gracefully once product-level features for report filtering are introduced by Aqua. 