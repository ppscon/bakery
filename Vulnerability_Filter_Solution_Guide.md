# Aqua Security Report Filtering Solution Guide

## Executive Summary

This document describes a custom solution developed for seamlessly filtering ignored vulnerabilities from Aqua Security scan reports. This implementation addresses a critical migration need, allowing the transition from PA Prisma to Aqua Security without disrupting existing workflows and reporting processes.

## Problem Statement

During migration from PA Prisma to Aqua Security, a key difference in handling ignored vulnerabilities was identified:

- **PA Prisma Behavior**: Completely removes ignored vulnerabilities from reports
- **Aqua Security Default Behavior**: Shows ignored vulnerabilities in reports but marks them as compliant

This difference would cause numerous previously-suppressed vulnerabilities to reappear in reports, potentially disrupting established security workflows and flooding existing downstream processes.

## Solution Overview

Rather than waiting for product-level changes, we implemented a post-processing step in the CI/CD pipeline that:

1. Captures the standard Aqua Security scan reports (JSON and HTML)
2. Automatically detects and filters out any vulnerabilities marked as ignored in Aqua
3. Generates enhanced, modernized reports from the filtered data
4. Publishes reports to GitHub Pages for easy access and sharing

This provides a seamless experience, allowing teams to focus only on actionable security issues while maintaining the benefits of Aqua's security scanning.

## Implementation Details

### Python Scripts

We developed three specialized Python scripts to handle the filtering and reporting:

#### 1. `filter_ignored_vulnerabilities.py`

This script processes Aqua's JSON report format:

- **Purpose**: Remove vulnerabilities marked as ignored from JSON reports
- **Functionality**:
  - Loads the original JSON report
  - Intelligently identifies vulnerabilities marked as ignored in Aqua
  - Removes ignored vulnerabilities from the report
  - Updates any relevant count or summary information
  - Outputs a clean, filtered JSON report
- **Usage**: `python filter_ignored_vulnerabilities.py input.json output.json`

```python
# Key functionality excerpt
def filter_ignored_vulnerabilities(input_file, output_file, ignored_cves=None):
    # Load JSON data
    with open(input_file, 'r') as f:
        scan_data = json.load(f)
    
    # Dynamically detect ignored vulnerabilities if not specified
    if ignored_cves is None:
        ignored_cves = find_ignored_vulnerabilities_in_report(scan_data)
    
    # Filter out ignored vulnerabilities
    if 'resources' in scan_data:
        for resource in scan_data['resources']:
            if 'vulnerabilities' in resource:
                resource['vulnerabilities'] = [
                    vuln for vuln in resource['vulnerabilities']
                    if vuln.get('name') not in ignored_cves
                ]
```

#### 2. `filter_html_report.py`

This script handles Aqua's HTML report format:

- **Purpose**: Remove ignored vulnerabilities from HTML reports and enhance presentation
- **Functionality**:
  - Parses the HTML report using BeautifulSoup
  - Identifies and removes elements containing ignored CVEs
  - Adds a visual indicator that the report has been filtered
  - Preserves the original report structure and styling
- **Usage**: `python filter_html_report.py input.html output.html`

```python
# Key functionality excerpt
def filter_html_report(input_file, output_file, ignored_cves=None):
    # Parse HTML with BeautifulSoup
    with open(input_file, 'r', encoding='utf-8') as f:
        soup = BeautifulSoup(f.read(), 'html.parser')
    
    # If no ignored CVEs provided, try to extract from corresponding JSON report
    if ignored_cves is None:
        json_report_path = os.path.join(os.path.dirname(input_file), 
                                       os.path.basename(input_file).replace('.html', '.json'))
        if os.path.exists(json_report_path):
            # Extract ignored CVEs from JSON report
            with open(json_report_path, 'r') as f:
                scan_data = json.load(f)
            ignored_cves = find_ignored_vulnerabilities_in_report(scan_data)
    
    # Find and remove ignored vulnerabilities
    for cve_id in ignored_cves:
        vuln_elements = soup.find_all(string=lambda text: text and cve_id in text)
        for element in vuln_elements:
            container = element.find_parent(['div', 'tr', 'section', 'table'])
            if container:
                container.decompose()
```

#### 3. `create_elegant_report.py`

This script transforms the filtered data into a modern, visually appealing report:

- **Purpose**: Generate a user-friendly, modern HTML dashboard from the filtered data
- **Functionality**:
  - Processes the filtered JSON data
  - Creates summary statistics for vulnerabilities by severity
  - Organizes vulnerabilities by resource/component
  - Produces a responsive HTML report with modern styling
- **Usage**: `python create_elegant_report.py filtered.json elegant_report.html`

### Integration with CI/CD Pipeline

The solution is fully integrated into the GitHub Actions workflow:

1. **Aqua Security Scan Job**:
   - Runs the standard Aqua security scan
   - Generates original JSON and HTML reports

2. **Filter Vulnerabilities Job**:
   - Downloads the original Aqua reports
   - Runs the filtering scripts to remove ignored vulnerabilities
   - Generates the elegant HTML report
   - Uploads filtered reports as artifacts

3. **GitHub Pages Publishing Job**:
   - Creates an index page for easy navigation
   - Publishes all reports to GitHub Pages
   - Makes reports accessible via URL: https://ppscon.github.io/bakery/security-reports/

```yaml
# Key workflow excerpt
filter_aqua_reports:
  runs-on: ubuntu-latest
  needs: aqua_scan
  steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Setup Python
      uses: actions/setup-python@v5
    - name: Install dependencies
      run: pip install beautifulsoup4
    - name: Filter ignored vulnerabilities
      run: python ci_scripts/filter_aqua_reports.py --input-dir artifacts --output-dir filtered-artifacts
    - name: Create elegant report
      run: python ci_scripts/create_elegant_report.py filtered-artifacts/aqua-scan-filtered.json filtered-artifacts/elegant-report.html
```

## Benefits

This solution provides several immediate benefits:

1. **Seamless Migration**: Maintains the same experience users had with PA Prisma
2. **Workflow Continuity**: Prevents ignored vulnerabilities from disrupting existing processes
3. **Enhanced Visualization**: Provides modern, intuitive security dashboards
4. **Improved Accessibility**: Makes reports available through GitHub Pages
5. **Minimal Overhead**: Integrates cleanly into existing pipeline with minimal impact
6. **Future Compatibility**: Can be easily removed when product-level features are available
7. **Zero Maintenance**: Automatically detects any vulnerability marked as ignored in Aqua UI

## Accessing Reports

Filtered security reports are available at:
- https://ppscon.github.io/bakery/security-reports/

The page provides access to:
- **Elegant Report**: Modern dashboard view of vulnerabilities
- **HTML Report**: Standard format but with ignored vulnerabilities removed
- **JSON Data**: Filtered data for integration with other tools

## Configuration Options

The solution offers multiple ways to control which vulnerabilities are filtered:

### 1. Automatic Detection (Default)

By default, the system automatically detects vulnerabilities that have been marked as ignored in the Aqua UI.

### 2. Environment Variables

You can provide specific CVEs to filter via environment variables:

```bash
export AQUA_IGNORED_CVES="CVE-2025-27789,CVE-2023-12345,CVE-2024-56789"
```

### 3. Configuration File

For more permanent configurations, you can use a JSON configuration file:

```json
{
  "ignored_cves": [
    "CVE-2025-27789",
    "CVE-2023-12345"
  ]
}
```

And use it with:

```bash
python ci_scripts/filter_aqua_reports.py --config-file ignored_cves_config.json
```

### 4. Command-Line Arguments

For one-off filtering, you can specify CVEs directly:

```bash
python ci_scripts/filter_aqua_reports.py --ignored-cves CVE-2025-27789 CVE-2023-12345
```

## Conclusion

This implementation provides an immediate solution to ensure a smooth transition from PA Prisma to Aqua Security. It maintains workflow continuity while providing enhanced visualization and reporting capabilities, all without requiring changes to the core Aqua product.

The intelligent design automatically adapts to your ignored vulnerability settings without manual maintenance, and can be retired gracefully once product-level features for report filtering are introduced by Aqua. 